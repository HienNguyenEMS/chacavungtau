<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªìng Nh√¢n Food - B√°nh M√¨ & Th·ª±c Ph·∫©m S·∫°ch</title>
    
    <meta name="description" content="ƒê·ªìng Nh√¢n Food chuy√™n cung c·∫•p b√°nh m√¨, ch·∫£ c√° v√† c√°c s·∫£n ph·∫©m th·ª±c ph·∫©m s·∫°ch. Nh·∫≠n ƒë·∫∑t h√†ng online v√† nh∆∞·ª£ng quy·ªÅn kinh doanh.">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%); }
        .card-shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        .interactive-card {
            transition: all 0.3s ease-in-out;
            border: 2px solid #e5e7eb; 
        }
        .interactive-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 20px rgba(16, 185, 129, 0.2);
            border-color: #059669; 
        }
        .dropdown { position: relative; }
        .dropdown-menu { 
            position: absolute; top: 100%; right: 0; background: white; 
            border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            min-width: 200px; z-index: 50; transform: translateY(10px) scale(0.95);
            opacity: 0; visibility: hidden; transition: all 0.2s ease; 
        }
        .dropdown-menu.show { transform: translateY(0) scale(1); opacity: 1; visibility: visible; }
        .mobile-nav-btn.active { color: #059669; background-color: #f0fdf4; }
        .dashboard-menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            color: #4b5563; /* gray-600 */
            transition: all 0.2s ease-in-out;
        }
        .dashboard-menu-item:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .dashboard-menu-item.active {
            background-color: #d1fae5; /* emerald-100 */
            color: #047857; /* emerald-800 */
            font-weight: 600;
        }
        .category-btn.active { background-color: #059669; color: white; border-color: #059669; }
        .payment-radio:checked + label {
            border-color: #059669;
            background-color: #f0fdf4;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.5);
        }
        .rating-stars span {
            cursor: pointer;
            font-size: 2.5rem;
            color: #d1d5db; /* gray-300 */
            transition: color 0.2s;
        }
        @media (max-width: 768px) {
            main { padding-bottom: 80px; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        main > section {
            padding-top: 2rem; 
            padding-bottom: 2rem; 
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-wrap items-center justify-between gap-x-4">
                <div class="flex items-center space-x-3 cursor-pointer flex-shrink-0" onclick="showSection('intro')">
                    <img src="https://raw.githubusercontent.com/HienNguyenEMS/chacavungtau/refs/heads/main/logo.jpg" alt="Logo" class="w-10 h-10 rounded-lg">
                    <!-- UPDATE 1: ·∫®n ch·ªØ tr√™n mobile -->
                    <div class="hidden md:block"><h1 class="text-xl font-bold">ƒê·ªìng Nh√¢n Food</h1></div>
                </div>
                
                <!-- Desktop Search Bar -->
                <div class="relative flex-grow max-w-xl hidden md:block">
                    <input type="text" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." class="w-full bg-white bg-opacity-20 rounded-full px-5 py-2 text-sm placeholder-emerald-100 focus:outline-none focus:bg-opacity-30 transition-all duration-300">
                    <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-emerald-100" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                
                <nav class="hidden md:flex space-x-5 items-center flex-shrink-0">
                    <button onclick="showSection('intro')" class="hover:text-amber-300 transition-colors">Trang ch·ªß</button>
                    <button onclick="showSection('menu')" class="hover:text-amber-300 transition-colors">S·∫£n ph·∫©m</button>
                    <button onclick="showSection('stores')" class="hover:text-amber-300 transition-colors">C·ª≠a h√†ng</button>
                    <button id="navCart" onclick="showSection('cart')" class="hover:text-amber-300 transition-colors relative hidden">
                        Gi·ªè h√†ng <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                    <div id="userMenuContainer" class="relative">
                        <div id="notLoggedIn" class="flex space-x-3">
                            <button onclick="showSection('login')" class="bg-white bg-opacity-20 px-3 py-1.5 rounded-lg hover:bg-opacity-30">ƒêƒÉng nh·∫≠p</button>
                            <button onclick="showSection('register')" class="bg-amber-400 text-slate-800 px-3 py-1.5 rounded-lg hover:bg-amber-300 font-semibold">ƒêƒÉng k√Ω</button>
                        </div>
                        <div id="loggedIn" class="hidden">
                            <div class="dropdown">
                                <button onclick="toggleUserDropdown()" class="flex items-center space-x-2 bg-white bg-opacity-20 px-3 py-1.5 rounded-lg hover:bg-opacity-30">
                                    <span class="text-xl">üë§</span><span id="userName" class="font-medium"></span>
                                    <svg class="w-4 h-4 transition-transform" id="userDropdownIcon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                </button>
                                <div id="userDropdownMenu" class="dropdown-menu">
                                    <button onclick="showSection('dashboard'); closeUserDropdown();" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-emerald-50 flex items-center space-x-2"><span>üìä</span><span>Dashboard</span></button>
                                    <hr class="my-1">
                                    <button onclick="logout(); closeUserDropdown();" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 flex items-center space-x-2"><span>üö™</span><span>ƒêƒÉng xu·∫•t</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
             <!-- Mobile Search Bar -->
             <div class="relative mt-3 md:hidden">
                <input type="text" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." class="w-full bg-white bg-opacity-20 rounded-full px-5 py-2 text-sm placeholder-emerald-100 focus:outline-none focus:bg-opacity-30 transition-all duration-300">
                <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-emerald-100" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>
    </header>
    
    <!-- Mobile Bottom Navigation -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t z-40">
        <div id="mobileNavGrid" class="grid grid-cols-3 h-16">
            <button onclick="showSection('intro')" class="mobile-nav-btn flex flex-col items-center justify-center space-y-1 text-gray-600" data-section="intro">
                <span class="text-xl">üè†</span><span class="text-xs font-medium">Trang ch·ªß</span>
            </button>
            <button onclick="showSection('menu')" class="mobile-nav-btn flex flex-col items-center justify-center space-y-1 text-gray-600 active" data-section="menu">
                <span class="text-xl">ü•ñ</span><span class="text-xs font-medium">S·∫£n ph·∫©m</span>
            </button>
            <button id="mobileNavCart" onclick="showSection('cart')" class="mobile-nav-btn flex-col items-center justify-center space-y-1 text-gray-600 relative hidden" data-section="cart">
                <span class="text-xl">üõí</span><span class="text-xs font-medium">Gi·ªè h√†ng</span>
                <span id="mobileCartCount" class="absolute top-1 right-4 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
            </button>
             <button onclick="isLoggedIn ? showSection('dashboard') : showSection('login')" class="mobile-nav-btn flex flex-col items-center justify-center space-y-1 text-gray-600" data-section="login">
                <span class="text-xl">üë§</span><span class="text-xs font-medium">T√†i kho·∫£n</span>
            </button>
        </div>
    </div>

    <main class="container mx-auto px-4 pt-4 pb-8">
        <section id="introSection" class="animate-fade-in"></section>
        <section id="menuSection" class="hidden animate-fade-in"></section>
        <section id="storesSection" class="hidden animate-fade-in"></section>
        <section id="cartSection" class="hidden animate-fade-in"></section>
        <section id="loginSection" class="hidden animate-fade-in"></section>
        <section id="registerSection" class="hidden animate-fade-in"></section>
        <section id="dashboardSection" class="hidden animate-fade-in"></section>
    </main>
    
    <footer class="bg-emerald-800 text-white pt-10 pb-5">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-6">
                <div>
                    <div class="flex items-center space-x-2 mb-3">
                        <img src="https://raw.githubusercontent.com/HienNguyenEMS/chacavungtau/refs/heads/main/logo.jpg" alt="Logo" class="w-10 h-10 rounded-lg">
                        <span class="font-bold text-lg">ƒê·ªìng Nh√¢n Food</span>
                    </div>
                    <p class="text-emerald-200 text-sm">Mang nh·ªØng s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng, an to√†n v√† ti·ªán l·ª£i ƒë·∫øn m·ªçi nh√†.</p>
                </div>
                <div>
                    <h3 class="font-bold mb-3">Li√™n k·∫øt nhanh</h3>
                    <ul class="space-y-1.5 text-emerald-200 text-sm">
                        <li><a href="#" onclick="event.preventDefault(); showSection('intro')" class="hover:text-white">Trang ch·ªß</a></li>
                        <li><a href="#" onclick="event.preventDefault(); showSection('menu')" class="hover:text-white">S·∫£n ph·∫©m</a></li>
                        <li><a href="#" onclick="event.preventDefault(); showSection('stores')" class="hover:text-white">C·ª≠a h√†ng</a></li>
                        <li><a href="#" onclick="event.preventDefault(); handleFranchiseClick()" class="hover:text-white">ƒêƒÉng k√Ω nh∆∞·ª£ng quy·ªÅn</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold mb-3">Li√™n h·ªá</h3>
                    <ul class="space-y-1.5 text-emerald-200 text-sm">
                        <li><strong>Hotline:</strong> 0934.945.967</li>
                        <li><strong>Email:</strong> lienhe@dongnhanfood.com</li>
                        <li><strong>Tr·ª• s·ªü:</strong> 3/564 ·∫§p 64, Xu√¢n Th·ªõi S∆°n, TPHCM</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold mb-3">M·∫°ng x√£ h·ªôi</h3>
                     <!-- UPDATE 2: Th√™m icons m·∫°ng x√£ h·ªôi -->
                     <div class="flex space-x-4">
                        <a href="https://www.facebook.com/share/15xupWfZQz/" target="_blank" rel="noopener noreferrer" class="text-emerald-200 hover:text-white" title="Facebook">
                            <img src="https://cdn-icons-png.flaticon.com/512/2175/2175193.png" alt="Facebook" class="w-6 h-6">
                        </a>
                        <a href="https://www.tiktok.com/@ch.c.vng.tung.nhn?_t=ZS-8zLJLzE0RRV&_r=1" target="_blank" rel="noopener noreferrer" class="text-emerald-200 hover:text-white" title="Tiktok">
                           <img src="https://cdn4.iconfinder.com/data/icons/social-media-flat-7/64/Social-media_Tiktok-512.png" alt="Tiktok" class="w-6 h-6">
                        </a>
                        <a href="https://zalo.me/3635285758582238200" target="_blank" rel="noopener noreferrer" class="text-emerald-200 hover:text-white" title="Zalo OA">
                             <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/2048px-Icon_of_Zalo.svg.png" alt="Zalo" class="w-6 h-6">
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-emerald-700 pt-5 text-center text-sm text-emerald-400">
                <p>&copy; 2025 ƒê·ªìng Nh√¢n Food | All Rights Reserved | <a href="#" class="hover:text-white">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</a> | <a href="#" class="hover:text-white">Tuy√™n b·ªë quy·ªÅn ri√™ng t∆∞</a></p>
            </div>
        </div>
    </footer>


    <!-- MODALS -->
    <div id="bankingPaymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>
    <div id="debtWarningModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>
    <div id="ratingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>
    <div id="orderDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>

    <!-- C√ÅC N√öT LI√äN H·ªÜ N·ªîI -->
    <div class="fixed bottom-20 right-5 z-40 flex flex-col space-y-3">
        <!-- N√∫t Zalo -->
        <a href="https://zalo.me/3635285758582238200" target="_blank" rel="noopener noreferrer" class="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-lg hover:bg-gray-100 transition-transform transform hover:scale-110 p-1" title="Chat Zalo">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/2048px-Icon_of_Zalo.svg.png" alt="Zalo" class="w-12 h-12">
        </a>
        <!-- N√∫t G·ªçi ƒêi·ªán -->
        <a href="tel:+84917353504" class="w-14 h-14 bg-green-500 rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 transition-transform transform hover:scale-110" title="G·ªçi Hotline">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
        </a>
    </div>
</body>

<script>
// --- STATE MANAGEMENT ---
let cart = [];
let currentUser = null;
let isLoggedIn = false;
let currentCategory = 'all';
let postLoginAction = null; 
const SHIPPING_FEE = 15000; 

let demoUsers = [
    { id: 1, name: 'Nguy·ªÖn VƒÉn A', email: 'demo@example.com', phone: '0901234567', password: '123456', debt: 150000, creditLimit: 200000, address: "123 ƒê∆∞·ªùng ABC, Ph∆∞·ªùng 1, TP V≈©ng T√†u" },
    { id: 2, name: 'Tr·∫ßn Th·ªã B', email: 'b@example.com', phone: '0987654321', password: '123456', debt: 190000, creditLimit: 200000, address: "456 ƒê∆∞·ªùng XYZ, Ph∆∞·ªùng 2, TP V≈©ng T√†u" }
];
let orderHistory = [
    { id: 1, code: 'DH12345', status: 'ƒêang x·ª≠ l√Ω', total: 153000, date: new Date('2025-08-26'), customerId: 1, shipper: null, rating: null,
      items: [
        { name: 'Ch·∫£ c√° t∆∞∆°i (kg)', quantity: 1, price: 120000 },
        { name: 'B√°nh m√¨ ch·∫£ c√° n√≥ng', quantity: 1, price: 18000 }
      ]},
    { id: 2, code: 'DH12346', status: 'Ho√†n th√†nh', total: 175000, date: new Date('2025-08-25'), customerId: 1, shipper: 'Nguy·ªÖn VƒÉn Giao', rating: null,
      items: [
        { name: 'Ch·∫£ c√° Nha Trang (kg)', quantity: 1, price: 135000 },
        { name: 'B√°nh m√¨ nem n∆∞·ªõng', quantity: 1, price: 25000 }
      ]},
    { id: 3, code: 'DH12347', status: 'Ho√†n th√†nh', total: 101000, date: new Date('2025-08-24'), customerId: 1, shipper: 'Tr·∫ßn Th·ªã V·∫≠n', rating: { stars: 5, comment: 'Giao h√†ng nhanh, s·∫£n ph·∫©m ngon!' },
      items: [
        { name: 'X√¥i ch·∫£ c√° ƒë·∫∑c bi·ªát', quantity: 2, price: 25000 },
        { name: 'B√°nh m√¨ ch·∫£ c√° n√≥ng', quantity: 2, price: 18000 }
      ]},
];

// --- TEMPLATES ---
const TEMPLATES = {
    intro: `
        <div class="bg-emerald-600 text-white rounded-2xl p-6 md:p-8 mb-10 card-shadow">
            <div class="text-center relative z-10">
                <h1 class="text-3xl md:text-5xl font-bold mb-3">B√°nh M√¨ Ngon - G·∫Øn K·∫øt C·ªông ƒê·ªìng</h1>
                <p class="text-md md:text-xl mb-6 text-emerald-100">S·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng t·ª´ ƒê·ªìng Nh√¢n Food</p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center items-center">
                    <div class="flex items-center space-x-2 bg-white bg-opacity-20 px-4 py-2 rounded-full">
                        <span class="text-xl">üìû</span><span class="font-semibold">Hotline: 0934.945.967</span>
                    </div>
                    <button onclick="showSection('menu')" class="bg-white text-emerald-600 px-6 py-2 rounded-full font-semibold hover:bg-emerald-50">Xem S·∫£n Ph·∫©m Ngay</button>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12 text-center">
            <div class="bg-white p-4 rounded-lg interactive-card"><div class="text-3xl mb-2">üåø</div><h3 class="text-lg font-bold mb-1">Nguy√™n Li·ªáu S·∫°ch</h3><p class="text-gray-600 text-sm">Ngu·ªìn nguy√™n li·ªáu ƒë∆∞·ª£c ch·ªçn l·ªçc k·ªπ l∆∞·ª°ng, ƒë·∫£m b·∫£o an to√†n v√† t∆∞∆°i ngon.</p></div>
            <div class="bg-white p-4 rounded-lg interactive-card"><div class="text-3xl mb-2">üõ°Ô∏è</div><h3 class="text-lg font-bold mb-1">An To√†n V·ªá Sinh</h3><p class="text-gray-600 text-sm">Quy tr√¨nh s·∫£n xu·∫•t hi·ªán ƒë·∫°i, ƒë·∫°t chu·∫©n an to√†n v·ªá sinh th·ª±c ph·∫©m.</p></div>
            <div class="bg-white p-4 rounded-lg interactive-card"><div class="text-3xl mb-2">üöö</div><h3 class="text-lg font-bold mb-1">Ti·ªán L·ª£i & Nhanh Ch√≥ng</h3><p class="text-gray-600 text-sm">H·ªá th·ªëng ph√¢n ph·ªëi r·ªông kh·∫Øp, mang s·∫£n ph·∫©m ƒë·∫øn tay b·∫°n nhanh nh·∫•t.</p></div>
        </div>
        <div class="bg-white rounded-lg card-shadow p-6 md:p-10 mb-12">
            <h2 class="text-2xl font-bold text-center text-emerald-800 mb-6">S·∫£n Ph·∫©m N·ªïi B·∫≠t</h2>
            <div id="featuredProductsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            <div class="text-center mt-8"><button onclick="showSection('menu')" class="bg-emerald-600 text-white px-6 py-2.5 rounded-full font-semibold hover:bg-emerald-700">Xem T·∫•t C·∫£ S·∫£n Ph·∫©m</button></div>
        </div>
        <div class="bg-white rounded-lg card-shadow p-6 md:p-10 mb-12 grid md:grid-cols-2 gap-8 items-center">
            <div>
                <h2 class="text-2xl font-bold text-emerald-800 mb-4">V·ªÅ ƒê·ªìng Nh√¢n Food</h2>
                <div class="text-gray-700 space-y-3">
                    <p>V·ªõi kinh nghi·ªám l√¢u nƒÉm, ƒê·ªìng Nh√¢n Food t·ª± h√†o mang ƒë·∫øn nh·ªØng s·∫£n ph·∫©m kh√¥ng ch·ªâ ngon mi·ªáng m√† c√≤n ƒë·∫£m b·∫£o an to√†n tuy·ªát ƒë·ªëi cho s·ª©c kh·ªèe. Ch√∫ng t√¥i chuy√™n:</p>
                    <ul class="space-y-2 list-inside list-disc marker:text-emerald-500">
                        <li>Cung c·∫•p Ch·∫£ C√° S·ª£i, Ch·∫£ C√° T∆∞∆°i, Ch·∫£ C√° Ch·ª£, Ch·∫£ C√° Nha Trang ch·∫•t l∆∞·ª£ng cao.</li>
                        <li>H∆∞·ªõng d·∫´n kh·ªüi nghi·ªáp m√¥ h√¨nh kinh doanh b√°nh m√¨ ch·∫£ c√° th√†nh c√¥ng.</li>
                        <li>Cung c·∫•p v√† cho thu√™ xe b√°nh m√¨, h·ªó tr·ª£ ƒë·ªëi t√°c t·ªëi ƒëa.</li>
                    </ul>
                </div>
            </div>
            <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden shadow-lg">
                 <iframe class="w-full h-full" src="https://www.youtube.com/embed/5kSmizoku8s" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>
        <div class="gradient-bg text-white rounded-lg p-6 text-center"><h2 class="text-2xl font-bold mb-3">S·∫µn s√†ng th∆∞·ªüng th·ª©c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng?</h2><button onclick="showSection('menu')" class="bg-white text-emerald-600 px-6 py-2.5 rounded-full font-semibold hover:bg-emerald-50 mt-2">ƒê·∫∑t H√†ng Ngay</button></div>`,
    menu: `<h2 class="text-3xl font-bold text-emerald-800 mb-8 text-center">S·∫£n Ph·∫©m C·ªßa Ch√∫ng T√¥i</h2>
           <div id="category-filters" class="flex flex-wrap justify-center gap-2 md:gap-4 mb-8">
               <button onclick="filterProducts('all', this)" class="category-btn active px-4 py-2 text-sm md:text-base md:px-6 rounded-full">T·∫•t c·∫£</button>
               <button onclick="filterProducts('banhmi', this)" class="category-btn bg-white border px-4 py-2 text-sm md:text-base md:px-6 rounded-full">B√°nh M√¨</button>
               <button onclick="filterProducts('chaca', this)" class="category-btn bg-white border px-4 py-2 text-sm md:text-base md:px-6 rounded-full">Ch·∫£ C√°</button>
               <button onclick="filterProducts('combo', this)" class="category-btn bg-white border px-4 py-2 text-sm md:text-base md:px-6 rounded-full">Combo</button>
           </div>
           <div id="productGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>`,
    stores: `<h2 class="text-3xl font-bold text-emerald-800 mb-8 text-center">H·ªá Th·ªëng C·ª≠a H√†ng</h2><div id="storeGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`,
    cart: `<div class="max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Gi·ªè H√†ng & Thanh To√°n</h2>
                <div id="cartContent"></div>
           </div>`,
    login: `<div class="max-w-md mx-auto bg-white rounded-lg card-shadow p-8"><h2 class="text-3xl font-bold text-center mb-8">ƒêƒÉng Nh·∫≠p</h2><form id="loginForm"><div class="space-y-4"><input type="text" id="loginIdentifier" required placeholder="Email ho·∫∑c SƒêT" class="w-full px-4 py-3 border rounded-lg"><input type="password" id="loginPassword" required placeholder="M·∫≠t kh·∫©u" class="w-full px-4 py-3 border rounded-lg"><button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-semibold">ƒêƒÉng nh·∫≠p</button></div></form><div id="loginMessage" class="mt-4 text-center text-sm"></div><p class="mt-6 text-center">Ch∆∞a c√≥ t√†i kho·∫£n? <button onclick="showSection('register')" class="text-emerald-600 font-medium">ƒêƒÉng k√Ω</button></p></div>`,
    register: `<div class="max-w-md mx-auto bg-white rounded-lg card-shadow p-8"><h2 class="text-3xl font-bold text-center mb-8">ƒêƒÉng K√Ω T√†i Kho·∫£n</h2><form id="registerForm"><div class="space-y-4"><input type="text" id="registerName" required placeholder="H·ªç v√† t√™n" class="w-full px-4 py-3 border rounded-lg"><input type="tel" id="registerPhone" required placeholder="S·ªë ƒëi·ªán tho·∫°i" class="w-full px-4 py-3 border rounded-lg"><input type="email" id="registerEmail" placeholder="Email (kh√¥ng b·∫Øt bu·ªôc)" class="w-full px-4 py-3 border rounded-lg"><input type="text" id="registerAddress" required placeholder="ƒê·ªãa ch·ªâ nh·∫≠n h√†ng" class="w-full px-4 py-3 border rounded-lg"><input type="password" id="registerPassword" required minlength="6" placeholder="M·∫≠t kh·∫©u (√≠t nh·∫•t 6 k√Ω t·ª±)" class="w-full px-4 py-3 border rounded-lg"><button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-semibold">T·∫°o t√†i kho·∫£n</button></div></form><div id="registerMessage" class="mt-4 text-center text-sm"></div><p class="mt-6 text-center">ƒê√£ c√≥ t√†i kho·∫£n? <button onclick="showSection('login')" class="text-emerald-600 font-medium">ƒêƒÉng nh·∫≠p</button></p></div>`,
    dashboard: `
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">T√†i Kho·∫£n C·ªßa T√¥i</h2>
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Left Sidebar Menu -->
                <aside class="w-full md:w-1/4 lg:w-1/5 flex-shrink-0">
                    <div class="bg-white rounded-lg card-shadow p-4 space-y-2">
                        <button onclick="showDashboardTab('overview', this)" class="dashboard-menu-item active"><span class="mr-3 text-xl">üìä</span>T·ªïng quan</button>
                        <button onclick="showDashboardTab('orders', this)" class="dashboard-menu-item"><span class="mr-3 text-xl">üì¶</span>ƒê∆°n h√†ng</button>
                        <button onclick="showDashboardTab('debt', this)" class="dashboard-menu-item"><span class="mr-3 text-xl">üìã</span>C√¥ng n·ª£</button>
                        <button onclick="showDashboardTab('profile', this)" class="dashboard-menu-item"><span class="mr-3 text-xl">üë§</span>T√†i kho·∫£n</button>
                        <hr class="my-2">
                        <button onclick="logout()" class="dashboard-menu-item w-full !text-red-600"><span class="mr-3 text-xl">üö™</span>ƒêƒÉng xu·∫•t</button>
                    </div>
                </aside>
                <!-- Right Content Area -->
                <div class="flex-grow bg-white rounded-lg card-shadow p-6">
                    <div id="overviewTab" class="dashboard-content animate-fade-in"></div>
                    <div id="ordersTab" class="dashboard-content hidden animate-fade-in"></div>
                    <div id="debtTab" class="dashboard-content hidden animate-fade-in"></div>
                    <div id="profileTab" class="dashboard-content hidden animate-fade-in"></div>
                </div>
            </div>
        </div>`,
    bankingPaymentModal: `<div class="bg-white rounded-lg p-6 max-w-md w-full animate-fade-in"><h3 class="text-2xl font-bold mb-4 text-center">Thanh to√°n VietQR</h3><img id="bankingQrImage" src="" alt="VietQR Code" class="w-64 h-64 mx-auto bg-gray-100 rounded-lg border"><div class="my-4 text-sm bg-gray-50 p-3 rounded-lg"><p><strong>S·ªë ti·ªÅn:</strong> <span id="bankingAmount" class="text-emerald-700 font-bold"></span></p><p><strong>N·ªôi dung:</strong> <span id="bankingContent" class="text-emerald-700"></span></p></div><button onclick="confirmBankingPayment()" class="w-full bg-green-600 text-white py-3 rounded-lg">T√¥i ƒë√£ thanh to√°n</button><button onclick="closeModal('bankingPaymentModal')" class="w-full mt-3 bg-gray-300 py-2 rounded-lg">ƒê√≥ng</button></div>`,
    debtWarningModal: `<div class="bg-white rounded-lg p-6 max-w-lg w-full animate-fade-in"><h3 class="text-2xl font-bold text-red-600 text-center mb-4">‚ö†Ô∏è Y√™u C·∫ßu Thanh To√°n C√¥ng N·ª£</h3><div id="debtWarningContent" class="bg-red-50 p-4 rounded-lg border border-red-200 mb-4 text-sm space-y-2"></div><p class="text-center mb-4">Vui l√≤ng thanh to√°n c√¥ng n·ª£ c≈© ƒë·ªÉ ti·∫øp t·ª•c ƒë·∫∑t h√†ng.</p><img id="debtQrImage" src="" alt="VietQR for Debt" class="w-56 h-56 mx-auto bg-gray-100 rounded-lg border"><button onclick="confirmDebtPayment()" class="w-full mt-4 bg-green-600 text-white py-3 rounded-lg">T√¥i ƒë√£ thanh to√°n c√¥ng n·ª£</button><button onclick="closeModal('debtWarningModal')" class="w-full mt-3 bg-gray-300 py-2 rounded-lg">ƒê√≥ng</button></div>`,
    ratingModal: `<div class="bg-white rounded-lg p-8 max-w-md w-full animate-fade-in">
        <h3 class="text-2xl font-bold text-center mb-2">ƒê√°nh gi√° ƒë∆°n h√†ng</h3>
        <p class="text-center text-gray-500 text-sm mb-4" id="ratingOrderInfo"></p>
        <div class="rating-stars text-center mb-6" onmouseout="resetStars()">
            <span onmouseover="handleStarHover(1)" onclick="setRating(1)">‚òÖ</span>
            <span onmouseover="handleStarHover(2)" onclick="setRating(2)">‚òÖ</span>
            <span onmouseover="handleStarHover(3)" onclick="setRating(3)">‚òÖ</span>
            <span onmouseover="handleStarHover(4)" onclick="setRating(4)">‚òÖ</span>
            <span onmouseover="handleStarHover(5)" onclick="setRating(5)">‚òÖ</span>
        </div>
        <textarea id="ratingComment" class="w-full p-3 border rounded-lg bg-gray-50" rows="3" placeholder="ƒê·ªÉ l·∫°i b√¨nh lu·∫≠n c·ªßa b·∫°n (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
        <input type="hidden" id="ratingValue" value="0">
        <div class="flex gap-4 mt-6">
            <button onclick="closeModal('ratingModal')" class="w-full bg-gray-300 py-2 rounded-lg">ƒê·ªÉ sau</button>
            <button id="submitRatingBtn" class="w-full bg-emerald-600 text-white py-2 rounded-lg">G·ª≠i ƒë√°nh gi√°</button>
        </div>
    </div>`,
    orderDetailModal: `
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full animate-fade-in relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('orderDetailModal')" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-center">Chi Ti·∫øt ƒê∆°n H√†ng <span id="detailOrderCode" class="text-emerald-600"></span></h3>
            
            <div class="grid md:grid-cols-2 gap-4 mb-4 text-sm bg-gray-50 p-4 rounded-lg">
                <div><strong>Ng√†y ƒë·∫∑t:</strong> <span id="detailOrderDate"></span></div>
                <div><strong>Tr·∫°ng th√°i:</strong> <span id="detailOrderStatus" class="font-semibold"></span></div>
                <div><strong>Ng∆∞·ªùi giao:</strong> <span id="detailOrderShipper"></span></div>
                <div><strong>T·ªïng ti·ªÅn:</strong> <span id="detailOrderTotal" class="font-bold text-lg text-red-600"></span></div>
            </div>

            <h4 class="font-semibold text-lg mb-2">S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t:</h4>
            <div id="detailOrderItems" class="space-y-2 border-t border-b py-3 mb-4">
                <!-- Item rows will be injected here -->
            </div>

            <h4 class="font-semibold text-lg mb-2">G·ª≠i y√™u c·∫ßu h·ªó tr·ª£</h4>
            <div class="space-y-3">
                <textarea id="orderRequestMessage" class="w-full p-3 border rounded-lg bg-gray-50" rows="3" placeholder="Nh·∫≠p n·ªôi dung y√™u c·∫ßu c·ªßa b·∫°n (v√≠ d·ª•: thay ƒë·ªïi ƒë·ªãa ch·ªâ, h·ªèi v·ªÅ t√¨nh tr·∫°ng ƒë∆°n h√†ng...)"></textarea>
                <button id="submitRequestBtn" class="w-full bg-emerald-600 text-white py-2.5 rounded-lg font-semibold hover:bg-emerald-700">G·ª≠i Y√™u C·∫ßu</button>
            </div>
        </div>
    `
};

// --- UI & NAVIGATION ---
function showSection(sectionName) {
    document.querySelectorAll('main > section').forEach(sec => sec.classList.add('hidden'));
    const sectionEl = document.getElementById(sectionName + 'Section');
    if (sectionEl) {
        sectionEl.innerHTML = TEMPLATES[sectionName] || '';
        sectionEl.classList.remove('hidden');
    }
    updateMobileNavigation(sectionName);
    window.scrollTo(0, 0);

    if (sectionName.match(/login|register/)) document.getElementById(`${sectionName}Form`).addEventListener('submit', sectionName === 'login' ? handleLogin : handleRegister);
    if (sectionName === 'intro') loadFeaturedProducts();
    if (sectionName === 'menu') filterProducts(currentCategory, document.querySelector('.category-btn.active'));
    if (sectionName === 'stores') loadStores();
    if (sectionName === 'cart') updateCartDisplay();
    if (sectionName === 'dashboard') loadDashboard();
}

function updateMobileNavigation(activeSection) {
    document.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-section') === activeSection));
}

function updateMenuVisibility() {
    const hasItems = cart.length > 0;
    document.getElementById('navCart').classList.toggle('hidden', !hasItems);
    const mobileNavCart = document.getElementById('mobileNavCart');
    mobileNavCart.classList.toggle('hidden', !hasItems);
    mobileNavCart.classList.toggle('flex', hasItems);
    
    const mobileNavGrid = document.getElementById('mobileNavGrid');
    let visibleItems = 2 + (hasItems ? 1 : 0) + 1;
    mobileNavGrid.style.gridTemplateColumns = `repeat(${visibleItems}, 1fr)`;
}

function closeModal(modalId) { 
    const modal = document.getElementById(modalId);
    if(modal) { modal.innerHTML = ''; modal.classList.add('hidden'); }
}

// --- CONTENT LOADING ---
function loadFeaturedProducts() {
    const grid = document.getElementById('featuredProductsGrid');
    if (grid) {
        grid.innerHTML = products.slice(0, 3).map(p => renderProductCard(p)).join('');
    }
}

function filterProducts(category, element) {
    currentCategory = category;
    document.querySelectorAll('#category-filters .category-btn').forEach(btn => btn.classList.remove('active'));
    element.classList.add('active');
    loadProducts();
}

function loadProducts() {
    const grid = document.getElementById('productGrid');
    if(!grid) return;
    const productsToDisplay = currentCategory === 'all' ? products : products.filter(p => p.category === currentCategory);
    grid.innerHTML = productsToDisplay.map(p => renderProductCard(p)).join('');
}

function renderProductCard(p) {
    const hasSale = p.salePrice && p.salePrice < p.price;
    const displayPrice = hasSale ? p.salePrice : p.price;
    const discountPercent = hasSale ? Math.round(((p.price - displayPrice) / p.price) * 100) : 0;

    return `
    <div class="bg-white rounded-lg card-shadow overflow-hidden interactive-card flex flex-col">
        <div class="relative">
            ${hasSale ? `<div class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-md z-10">-${discountPercent}%</div>` : ''}
            <div class="h-48 bg-gray-100 flex items-center justify-center text-5xl">${p.image}</div>
        </div>
        <div class="p-4 flex flex-col flex-grow">
            <h3 class="font-bold text-lg truncate mb-2" title="${p.name}">${p.name}</h3>
            <div class="flex items-center justify-between mt-auto">
                <div>
                    <span class="font-semibold text-emerald-700 text-xl">${displayPrice.toLocaleString()}ƒë</span>
                    ${hasSale ? `<span class="line-through text-gray-400 text-sm ml-2">${p.price.toLocaleString()}ƒë</span>` : ''}
                </div>
                <div id="product-actions-${p.id}" class="w-28 flex-shrink-0">
                    ${generateProductActions(p)}
                </div>
            </div>
        </div>
    </div>`;
}


function generateProductActions(p) {
    const cartItem = cart.find(item => item.id === p.id);
    if (cartItem) {
        return `
        <div class="flex items-center justify-end gap-1">
             <button onclick="updateCartQuantity(${p.id}, -0.5)" class="w-8 h-8 bg-gray-200 rounded-md font-bold text-lg flex-shrink-0">-</button>
             <input type="number" value="${cartItem.quantity}" step="0.5" min="0" onchange="updateCartQuantityFromInput(${p.id}, this.value)" class="w-12 h-8 text-center font-bold border-gray-300 border rounded-md">
             <button onclick="updateCartQuantity(${p.id}, 0.5)" class="w-8 h-8 bg-gray-200 rounded-md font-bold text-lg flex-shrink-0">+</button>
        </div>`;
    } else {
        return `<button onclick="addToCart(${p.id})" class="w-full text-white py-2 rounded-lg font-semibold bg-emerald-600 hover:bg-emerald-700 transition-colors text-sm">Mua ngay</button>`;
    }
}


function loadStores() {
    const grid = document.getElementById('storeGrid');
    if(grid) grid.innerHTML = branches.map(b => `<div class="bg-white rounded-lg card-shadow p-6 border-l-4 border-amber-500 interactive-card"><h3 class="font-bold text-lg">${b.emoji} ${b.name}</h3><p class="text-sm text-gray-600 mt-2">üìç ${b.address}</p><p class="text-sm text-gray-600 mt-1">üìû ${b.phone}</p></div>`).join('');
}

// --- CART LOGIC ---
function addToCart(productId, quantity = 1) {
    const product = products.find(p => p.id === productId);
    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) existingItem.quantity += quantity;
    else cart.push({ ...product, quantity });
    showNotification(`${product.name} ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè.`);
    updateAllUI();
}

function updateCartQuantity(productId, change) {
    let item = cart.find(item => item.id === productId);
    if (!item) { if(change > 0) addToCart(productId, change); return; }
    item.quantity = Math.max(0, item.quantity + change);
    if (item.quantity === 0) cart = cart.filter(i => i.id !== productId);
    updateAllUI();
}

function updateCartQuantityFromInput(productId, value) {
    const newQuantity = parseFloat(value);
    if (isNaN(newQuantity) || newQuantity < 0) return;
    let item = cart.find(i => i.id === productId);
    if (newQuantity === 0) cart = cart.filter(i => i.id !== productId);
    else { if (item) item.quantity = newQuantity; else cart.push({ ...products.find(p => p.id === productId), quantity: newQuantity }); }
    updateAllUI();
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.id !== productId);
    updateAllUI();
}

function updateCartDisplay() {
    const cartContentEl = document.getElementById('cartContent');
    if (!cartContentEl) return;
    if (cart.length === 0) {
        cartContentEl.innerHTML = `<div class="text-center py-12"><h3 class="text-xl text-gray-600">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</h3><button onclick="showSection('menu')" class="mt-4 bg-emerald-600 text-white px-6 py-2 rounded-lg">Mua s·∫Øm ngay</button></div>`;
    } else {
        const subtotal = cart.reduce((s, i) => s + (i.salePrice || i.price) * i.quantity, 0);
        const finalTotal = subtotal + SHIPPING_FEE;

        cartContentEl.innerHTML = `
            <div class="grid lg:grid-cols-3 gap-8 items-start">
                <div class="lg:col-span-2 bg-white rounded-lg card-shadow p-6">
                    <h3 class="text-xl font-semibold mb-4">Chi ti·∫øt ƒë∆°n h√†ng</h3>
                    <div id="cartItems" class="space-y-4">${cart.map(item => `
                        <div class="flex items-center gap-4 border-b pb-4 last:border-b-0 last:pb-0">
                            <div class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 text-3xl">${item.image}</div>
                            <div class="flex-1"><h3 class="font-semibold">${item.name}</h3><p class="text-emerald-600">${(item.salePrice || item.price).toLocaleString()}ƒë</p></div>
                            <div class="flex items-center gap-2"><button onclick="updateCartQuantity(${item.id}, -0.5)" class="w-7 h-7 bg-gray-200 rounded-md font-bold">-</button><input type="number" value="${item.quantity}" step="0.5" onchange="updateCartQuantityFromInput(${item.id}, this.value)" class="w-16 h-7 text-center font-bold border-gray-300 border rounded-md"><button onclick="updateCartQuantity(${item.id}, 0.5)" class="w-7 h-7 bg-gray-200 rounded-md font-bold">+</button></div>
                            <p class="font-bold text-lg w-28 text-right">${((item.salePrice || item.price) * item.quantity).toLocaleString()}ƒë</p>
                            <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700 p-2">‚úñ</button>
                        </div>`).join('')}
                    </div>
                </div>
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg card-shadow p-6 sticky top-24 space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Th√¥ng tin giao h√†ng</h3>
                            <form id="checkoutForm" class="space-y-4">
                                <input type="tel" id="checkoutPhone" required placeholder="S·ªë ƒëi·ªán tho·∫°i" class="w-full px-4 py-2 border rounded-lg bg-gray-50" onblur="checkCustomerByPhone(this.value)">
                                <input type="text" id="checkoutName" required placeholder="H·ªç v√† t√™n" class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                                <input type="text" id="checkoutAddress" required placeholder="ƒê·ªãa ch·ªâ nh·∫≠n h√†ng" class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                                <div id="registrationFields" class="hidden space-y-4">
                                    <p class="text-sm text-blue-600 bg-blue-50 p-3 rounded-md">SƒêT m·ªõi! Vui l√≤ng t·∫°o m·∫≠t kh·∫©u ƒë·ªÉ ƒëƒÉng k√Ω v√† ƒë·∫∑t h√†ng.</p>
                                    <input type="password" id="checkoutPassword" placeholder="T·∫°o m·∫≠t kh·∫©u (√≠t nh·∫•t 6 k√Ω t·ª±)" class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                                </div>
                            </form>
                        </div>
                        <div class="border-t pt-6">
                             <h3 class="text-xl font-semibold mb-4">H√¨nh th·ª©c thanh to√°n</h3>
                             <div class="space-y-3">
                                <div><input type="radio" name="paymentMethod" id="paymentBanking" value="banking" class="hidden payment-radio" checked><label for="paymentBanking" class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"><span class="text-2xl mr-4">üí≥</span><div><span class="font-semibold">Thanh to√°n Banking</span><p class="text-sm text-gray-500">Chuy·ªÉn kho·∫£n tr·∫£ tr∆∞·ªõc.</p></div></label></div>
                                <div><input type="radio" name="paymentMethod" id="paymentDebt" value="debt" class="hidden payment-radio"><label for="paymentDebt" class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"><span class="text-2xl mr-4">üìã</span><div><span class="font-semibold">Ghi c√¥ng n·ª£</span><p class="text-sm text-gray-500">√Åp d·ª•ng cho kh√°ch h√†ng th√¢n thi·∫øt.</p></div></label></div>
                             </div>
                        </div>
                        <div class="border-t pt-6">
                            <h3 class="text-xl font-semibold mb-4">T·ªïng k·∫øt</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between text-gray-600"><span>T·∫°m t√≠nh:</span><span>${subtotal.toLocaleString()}ƒë</span></div>
                                <div class="flex justify-between text-gray-600"><span>Ph√≠ giao h√†ng:</span><span>${SHIPPING_FEE.toLocaleString()}ƒë</span></div>
                                <div class="flex justify-between text-xl font-bold"><span class="text-gray-800">T·ªïng thanh to√°n:</span><span class="text-emerald-600">${finalTotal.toLocaleString()}ƒë</span></div>
                            </div>
                        </div>
                        <div class="mt-2"><button onclick="proceedToOrder()" class="w-full bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 text-lg font-semibold">ƒê·∫∑t H√†ng</button></div>
                    </div>
                </div>
            </div>`;
        
        if (isLoggedIn) {
            document.getElementById('checkoutPhone').value = currentUser.phone;
            document.getElementById('checkoutName').value = currentUser.name;
            document.getElementById('checkoutAddress').value = currentUser.address;
        }
    }
}
function checkCustomerByPhone(phone) {
    if (isLoggedIn) return;
    const customer = demoUsers.find(u => u.phone === phone);
    const regFields = document.getElementById('registrationFields');
    const nameField = document.getElementById('checkoutName');
    const addressField = document.getElementById('checkoutAddress');
    const passwordField = document.getElementById('checkoutPassword');

    if (customer) {
        nameField.value = customer.name;
        addressField.value = customer.address;
        regFields.classList.add('hidden');
        passwordField.required = false;
    } else {
        nameField.value = '';
        addressField.value = '';
        regFields.classList.remove('hidden');
        passwordField.required = true;
    }
}


// --- PAYMENT & FRANCHISE FLOW ---
async function proceedToOrder() {
    const form = document.getElementById('checkoutForm');
    if (!form || !form.checkValidity()) {
        form.reportValidity();
        showNotification("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.", true);
        return;
    }

    const isRegistering = !document.getElementById('registrationFields').classList.contains('hidden');
    if (!isLoggedIn && isRegistering) {
        const success = await handleRegisterAndCheckout();
        if (!success) return; 
    }
    
    const newAddress = document.getElementById('checkoutAddress').value;
    if (isLoggedIn && currentUser.address !== newAddress) {
        if (confirm('B·∫°n c√≥ mu·ªën c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ giao h√†ng m·ªõi n√†y cho l·∫ßn sau kh√¥ng?')) {
            currentUser.address = newAddress;
            const userInDb = demoUsers.find(u => u.id === currentUser.id);
            if(userInDb) userInDb.address = newAddress;
            showNotification('ƒê√£ c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ m·ªõi.');
        }
    }

    const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked').value;
    const subtotal = cart.reduce((s, i) => s + (i.salePrice || i.price) * i.quantity, 0);
    const finalTotal = subtotal + SHIPPING_FEE;
    const phone = document.getElementById('checkoutPhone').value;

    if (selectedPayment === 'banking') {
        showBankingPayment(finalTotal);
    } else if (selectedPayment === 'debt') {
        const customer = demoUsers.find(u => u.phone === phone);
        if (!customer) {
            showNotification("SƒêT ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√Ω c√¥ng n·ª£. Vui l√≤ng ch·ªçn Banking ho·∫∑c li√™n h·ªá c·ª≠a h√†ng.", true);
            return;
        }
        const newDebtTotal = customer.debt + subtotal; // C√¥ng n·ª£ kh√¥ng t√≠nh ph√≠ ship
        if (newDebtTotal > customer.creditLimit) {
            showDebtWarning(customer);
        } else {
            customer.debt = newDebtTotal;
            orderHistory.push({ id: Date.now(), code: 'DH' + Date.now().toString().slice(-6), status: 'ƒêang x·ª≠ l√Ω', total: finalTotal, date: new Date(), customerId: customer.id, shipper: null, rating: null });
            cart = [];
            showNotification("ƒê·∫∑t h√†ng c√¥ng n·ª£ th√†nh c√¥ng!");
            updateAllUI();
            showSection('dashboard');
        }
    }
}

function generateVietQRUrl(amount, content) {
    const BANK_ID = "970422";
    const ACCOUNT_NO = "0934945967";
    const ACCOUNT_NAME = "NGUYEN CHI THANH";
    const TEMPLATE = "compact2";
    return `https://img.vietqr.io/image/${BANK_ID}-${ACCOUNT_NO}-${TEMPLATE}.png?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(ACCOUNT_NAME)}`;
}


function showBankingPayment(amount) {
    const modal = document.getElementById('bankingPaymentModal');
    modal.innerHTML = TEMPLATES.bankingPaymentModal;
    const orderId = 'DH' + Date.now().toString().slice(-6);
    const qrContent = `TT ${orderId}`;
    document.getElementById('bankingQrImage').src = generateVietQRUrl(amount, qrContent);
    document.getElementById('bankingAmount').textContent = `${amount.toLocaleString()}ƒë`;
    document.getElementById('bankingContent').textContent = qrContent;
    modal.classList.remove('hidden');
}

function confirmBankingPayment() {
    const total = cart.reduce((s, i) => s + (i.salePrice || i.price) * i.quantity, 0) + SHIPPING_FEE;
    const customerId = isLoggedIn ? currentUser.id : null;
    orderHistory.push({ id: Date.now(), code: 'DH' + Date.now().toString().slice(-6), status: 'ƒêang x·ª≠ l√Ω', total: total, date: new Date(), customerId: customerId, shipper: null, rating: null });
    cart = [];
    closeModal('bankingPaymentModal');
    showNotification("Thanh to√°n th√†nh c√¥ng! ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.");
    updateAllUI();
    showSection(isLoggedIn ? 'dashboard' : 'intro');
}


function showDebtWarning(customer) {
    const modal = document.getElementById('debtWarningModal');
    modal.innerHTML = TEMPLATES.debtWarningModal;
    document.getElementById('debtWarningContent').innerHTML = `<p>C√¥ng n·ª£ hi·ªán t·∫°i c·ªßa SƒêT <strong class="text-red-600">${customer.phone}</strong> l√†: <strong class="text-red-600">${customer.debt.toLocaleString()}ƒë</strong></p><p>H·∫°n m·ª©c c·ªßa b·∫°n l√†: <strong>${customer.creditLimit.toLocaleString()}ƒë</strong></p><p>ƒê∆°n h√†ng m·ªõi c·ªßa b·∫°n ƒë√£ l√†m v∆∞·ª£t h·∫°n m·ª©c t√≠n d·ª•ng.</p>`;
    document.getElementById('debtQrImage').src = generateVietQRUrl(customer.debt, `TT Cong No ${customer.phone}`);
    modal.setAttribute('data-customer-id', customer.id);
    modal.classList.remove('hidden');
}

function confirmDebtPayment() {
    const modal = document.getElementById('debtWarningModal');
    const customerId = modal.getAttribute('data-customer-id');
    const customer = demoUsers.find(u => u.id == customerId);
    if(customer) customer.debt = 0;
    showNotification("ƒê√£ ghi nh·∫≠n thanh to√°n. Vui l√≤ng ƒë·∫∑t l·∫°i ƒë∆°n h√†ng.", false);
    closeModal('debtWarningModal');
    updateAllUI();
    showSection('cart');
}

// --- LOGIN & REGISTER & USER ---
function handleLogin(event) {
    event.preventDefault();
    const id = document.getElementById('loginIdentifier').value;
    const pass = document.getElementById('loginPassword').value;
    const user = demoUsers.find(u => (u.email === id || u.phone === id) && u.password === pass);
    if (user) {
        loginUser(user);
        if (postLoginAction) { postLoginAction(); postLoginAction = null; } 
        else { showSection('intro'); }
    } else {
        document.getElementById('loginMessage').innerHTML = `<p class="text-red-500">Th√¥ng tin kh√¥ng ch√≠nh x√°c.</p>`;
    }
}

function handleRegister(event) {
    event.preventDefault();
    const name = document.getElementById('registerName').value;
    const phone = document.getElementById('registerPhone').value;
    const email = document.getElementById('registerEmail').value;
    const address = document.getElementById('registerAddress').value;
    const pass = document.getElementById('registerPassword').value;
    const msgEl = document.getElementById('registerMessage');

    if (demoUsers.some(u => u.phone === phone)) {
        msgEl.innerHTML = `<p class="text-red-500">S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i.</p>`; return;
    }
    const newUser = { id: Date.now(), name, email, phone, password: pass, debt: 0, creditLimit: 200000, address };
    demoUsers.push(newUser);
    msgEl.innerHTML = `<p class="text-green-500">ƒêƒÉng k√Ω th√†nh c√¥ng! ƒêang t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p...</p>`;
    setTimeout(() => {
        loginUser(newUser);
        if (postLoginAction) { postLoginAction(); postLoginAction = null; } 
        else { showSection('intro'); }
    }, 1500);
}
async function handleRegisterAndCheckout() {
    const name = document.getElementById('checkoutName').value;
    const phone = document.getElementById('checkoutPhone').value;
    const address = document.getElementById('checkoutAddress').value;
    const pass = document.getElementById('checkoutPassword').value;

    if (pass.length < 6) {
        showNotification('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.', true);
        return false;
    }
    if (demoUsers.some(u => u.phone === phone)) {
        showNotification('S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ƒëƒÉng nh·∫≠p.', true);
        return false;
    }
    const newUser = { id: Date.now(), name, phone, address, password: pass, email: '', debt: 0, creditLimit: 200000 };
    demoUsers.push(newUser);
    loginUser(newUser);
    showNotification(`ƒêƒÉng k√Ω th√†nh c√¥ng! Ch√†o m·ª´ng ${name}.`, false);
    return true;
}

function loginUser(user) {
    currentUser = user;
    isLoggedIn = true;
    localStorage.setItem('loggedInUserId', user.id);
    updateAllUI();
}
function logout() {
    currentUser = null;
    isLoggedIn = false;
    localStorage.removeItem('loggedInUserId');
    updateAllUI();
    showSection('intro');
    showNotification('ƒê√£ ƒëƒÉng xu·∫•t!');
}

// --- DASHBOARD ---
function loadDashboard() { 
    if (!isLoggedIn) { postLoginAction = () => showSection('dashboard'); showSection('login'); return; }
    showDashboardTab('overview', document.querySelector('.dashboard-menu-item')); 
}

function showDashboardTab(tabName, clickedElement) {
    document.querySelectorAll('.dashboard-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(tabName + 'Tab').classList.remove('hidden');
    document.querySelectorAll('.dashboard-menu-item').forEach(btn => btn.classList.remove('active'));
    clickedElement.classList.add('active');

    if (tabName === 'overview') loadDashboardOverview();
    if (tabName === 'orders') loadOrders();
    if (tabName === 'debt') loadDebtInfo();
    if (tabName === 'profile') loadProfileInfo();
}

function loadDashboardOverview() {
    const el = document.getElementById('overviewTab');
    const userOrders = orderHistory.filter(o => o.customerId === currentUser.id);
    const processing = userOrders.filter(o => o.status.includes('ƒêang x·ª≠ l√Ω')).length;
    el.innerHTML = `<h3 class="text-2xl font-semibold mb-6">T·ªïng quan</h3><div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="bg-emerald-50 p-6 rounded-lg"><p class="font-medium text-emerald-600">T·ªïng ƒë∆°n h√†ng</p><p class="text-3xl font-bold mt-2">${userOrders.length}</p></div>
        <div class="bg-amber-50 p-6 rounded-lg"><p class="font-medium text-amber-600">ƒêang x·ª≠ l√Ω</p><p class="text-3xl font-bold mt-2">${processing}</p></div>
        <div class="bg-red-50 p-6 rounded-lg"><p class="font-medium text-red-600">C√¥ng n·ª£</p><p class="text-3xl font-bold mt-2">${(currentUser.debt || 0).toLocaleString()}ƒë</p></div>
    </div>`;
}

function loadOrders() {
    const el = document.getElementById('ordersTab');
    const userOrders = orderHistory.filter(o => o.customerId === currentUser.id).sort((a, b) => b.date - a.date);
    if (userOrders.length === 0) el.innerHTML = '<p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>';
    else el.innerHTML = `<h3 class="text-2xl font-semibold mb-6">L·ªãch s·ª≠ ƒë∆°n h√†ng</h3><div class="space-y-4">${userOrders.map(o => {
        let ratingHtml = '';
        if (o.status === 'Ho√†n th√†nh') {
            if (o.rating) {
                ratingHtml = `<div class="mt-2 pt-2 border-t">
                    <p class="text-sm text-gray-600">ƒê√°nh gi√° c·ªßa b·∫°n: <span class="text-amber-500 font-bold">${'‚òÖ'.repeat(o.rating.stars)}${'‚òÜ'.repeat(5 - o.rating.stars)}</span></p>
                    ${o.rating.comment ? `<p class="text-sm text-gray-500 italic">"${o.rating.comment}"</p>` : ''}
                </div>`;
            } else {
                ratingHtml = `<div class="mt-3"><button class="bg-amber-500 text-white text-sm px-4 py-1.5 rounded-md hover:bg-amber-600" onclick="event.stopPropagation(); openRatingModal(${o.id})">ƒê√°nh gi√° ƒë∆°n h√†ng</button></div>`;
            }
        }

        return `<div class="bg-gray-50 p-4 rounded-lg shadow-sm cursor-pointer hover:bg-gray-100 transition-colors" onclick="showOrderDetail(${o.id})">
            <div class="flex justify-between items-start">
                <div>
                    <p><strong>M√£ ƒêH:</strong> ${o.code}</p>
                    <p><strong>Ng√†y:</strong> ${o.date.toLocaleDateString('vi-VN')}</p>
                </div>
                <span class="text-orange-500 font-semibold bg-orange-100 px-2 py-1 rounded-md text-sm">${o.status}</span>
            </div>
            <p><strong>T·ªïng ti·ªÅn:</strong> ${o.total.toLocaleString()}ƒë</p>
            ${o.shipper ? `<p class="text-sm text-gray-600"><strong>Shipper:</strong> ${o.shipper}</p>` : ''}
            ${ratingHtml}
        </div>`;
    }).join('')}</div>`;
}

// --- ORDER DETAIL FUNCTIONS ---
function showOrderDetail(orderId) {
    const modal = document.getElementById('orderDetailModal');
    modal.innerHTML = TEMPLATES.orderDetailModal;

    const order = orderHistory.find(o => o.id === orderId);
    if (!order) return;

    // Populate general info
    document.getElementById('detailOrderCode').textContent = order.code;
    document.getElementById('detailOrderDate').textContent = order.date.toLocaleDateString('vi-VN');
    document.getElementById('detailOrderStatus').textContent = order.status;
    document.getElementById('detailOrderShipper').textContent = order.shipper || 'Ch∆∞a c√≥';
    document.getElementById('detailOrderTotal').textContent = `${order.total.toLocaleString()}ƒë`;
    
    // Populate status color
    const statusEl = document.getElementById('detailOrderStatus');
    if (order.status === 'Ho√†n th√†nh') statusEl.classList.add('text-green-600');
    else if (order.status === 'ƒêang x·ª≠ l√Ω') statusEl.classList.add('text-orange-500');
    else statusEl.classList.add('text-red-500');

    // Populate items
    const itemsContainer = document.getElementById('detailOrderItems');
    itemsContainer.innerHTML = order.items.map(item => `
        <div class="flex justify-between items-center text-sm">
            <div>
                <span class="font-medium">${item.name}</span>
                <span class="text-gray-500"> x ${item.quantity}</span>
            </div>
            <div class="text-gray-700">${(item.price * item.quantity).toLocaleString()}ƒë</div>
        </div>
    `).join('');
    
    const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const shipping = order.total - subtotal;
    itemsContainer.innerHTML += `
        <div class="flex justify-between items-center text-sm pt-2 border-t mt-2">
            <div class="text-gray-500">T·∫°m t√≠nh</div>
            <div class="text-gray-700">${subtotal.toLocaleString()}ƒë</div>
        </div>
        <div class="flex justify-between items-center text-sm">
            <div class="text-gray-500">Ph√≠ giao h√†ng</div>
            <div class="text-gray-700">${shipping > 0 ? shipping.toLocaleString() : '0'}ƒë</div>
        </div>
    `;

    // Setup request button
    document.getElementById('submitRequestBtn').onclick = () => submitOrderRequest(order.id);
    modal.classList.remove('hidden');
}

function submitOrderRequest(orderId) {
    const message = document.getElementById('orderRequestMessage').value;
    if (!message.trim()) {
        showNotification('Vui l√≤ng nh·∫≠p n·ªôi dung y√™u c·∫ßu.', true);
        return;
    }
    console.log(`Request for order ${orderId}: ${message}`);
    showNotification('Y√™u c·∫ßu c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn admin.');
    closeModal('orderDetailModal');
}

// --- RATING FUNCTIONS ---
function openRatingModal(orderId) {
    const modal = document.getElementById('ratingModal');
    modal.innerHTML = TEMPLATES.ratingModal;
    const order = orderHistory.find(o => o.id === orderId);
    if (!order) return;
    document.getElementById('ratingOrderInfo').textContent = `M√£ ƒêH: ${order.code} - Shipper: ${order.shipper}`;
    document.getElementById('submitRatingBtn').onclick = () => submitRating(orderId);
    modal.classList.remove('hidden');
}

function handleStarHover(starCount) {
    const stars = document.querySelectorAll('.rating-stars span');
    stars.forEach((star, index) => {
        star.style.color = index < starCount ? '#f59e0b' : '#d1d5db';
    });
}
function resetStars() {
    const rating = document.getElementById('ratingValue').value;
    handleStarHover(rating);
}
function setRating(starCount) {
    document.getElementById('ratingValue').value = starCount;
    handleStarHover(starCount);
}
function submitRating(orderId) {
    const stars = parseInt(document.getElementById('ratingValue').value);
    if (stars === 0) {
        showNotification('Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°.', true);
        return;
    }
    const comment = document.getElementById('ratingComment').value;
    const order = orderHistory.find(o => o.id === orderId);
    order.rating = { stars, comment };
    closeModal('ratingModal');
    showNotification('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!');
    loadOrders(); // Re-render the orders tab
}


function loadDebtInfo() {
    const el = document.getElementById('debtTab');
    el.innerHTML = `<h3 class="text-2xl font-semibold mb-6">Th√¥ng Tin C√¥ng N·ª£</h3><div class="bg-white p-6 rounded-lg max-w-md"><div class="space-y-3"><p class="text-lg">C√¥ng n·ª£ hi·ªán t·∫°i: <strong class="text-red-500 text-2xl">${(currentUser.debt || 0).toLocaleString()}ƒë</strong></p><p class="text-gray-600">H·∫°n m·ª©c t√≠n d·ª•ng: <strong>${(currentUser.creditLimit || 0).toLocaleString()}ƒë</strong></p></div><button onclick="showDebtWarning(currentUser)" class="w-full mt-6 bg-red-600 text-white py-2.5 rounded-lg hover:bg-red-700">Thanh to√°n ngay</button></div>`;
}

function loadProfileInfo() {
    const el = document.getElementById('profileTab');
    el.innerHTML = `<h3 class="text-2xl font-semibold mb-6">Th√¥ng Tin T√†i Kho·∫£n</h3><div class="bg-white p-6 rounded-lg max-w-md"><div class="space-y-3 text-lg"><p><strong>H·ªç t√™n:</strong> ${currentUser.name}</p><p><strong>Email:</strong> ${currentUser.email || "Ch∆∞a c·∫≠p nh·∫≠t"}</p><p><strong>SƒêT:</strong> ${currentUser.phone}</p><p><strong>ƒê·ªãa ch·ªâ:</strong> ${currentUser.address || "Ch∆∞a c·∫≠p nh·∫≠t"}</p></div></div>`;
}


// --- UTILITY ---
function showNotification(message, isError = false) {
    const el = document.createElement('div');
    const bgColor = isError ? 'bg-red-500' : 'bg-green-500';
    el.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
    el.textContent = message;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
}

function updateAllUI() {
    document.querySelectorAll('#cartCount, #mobileCartCount').forEach(el => { 
        const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
        el.textContent = Number.isInteger(totalItems) ? totalItems : totalItems.toFixed(1);
    });
    updateMenuVisibility();
    updateLoginUI();
    const visibleSection = document.querySelector('main > section:not(.hidden)');
    if (visibleSection) {
        const sectionId = visibleSection.id.replace('Section', '');
        if (sectionId === 'menu') loadProducts();
        if (sectionId === 'cart') updateCartDisplay();
        if (sectionId === 'intro') loadFeaturedProducts();
    }
}

function updateLoginUI() {
    document.getElementById('notLoggedIn').classList.toggle('hidden', isLoggedIn);
    document.getElementById('loggedIn').classList.toggle('hidden', !isLoggedIn);
    if (isLoggedIn) document.getElementById('userName').textContent = currentUser.name.split(' ').pop();
}

function toggleUserDropdown() { document.getElementById('userDropdownMenu').classList.toggle('show'); }
function closeUserDropdown() { document.getElementById('userDropdownMenu').classList.remove('show'); }

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    const savedUserId = localStorage.getItem('loggedInUserId');
    if (savedUserId) {
        const user = demoUsers.find(u => u.id == savedUserId);
        if (user) loginUser(user);
    }
    const isMobile = window.innerWidth < 768;
    if (isMobile) {
        showSection('menu');
    } else {
        showSection('intro');
    }
    updateAllUI();
    window.addEventListener('click', (e) => {
        if (!document.querySelector('.dropdown')?.contains(e.target)) closeUserDropdown();
    });
});

// --- DUMMY DATA ---
const products = [
    { id: 1, name: 'B√°nh m√¨ ch·∫£ c√° n√≥ng', price: 20000, salePrice: 18000, category: 'banhmi', image: 'ü•ñ' },
    { id: 2, name: 'Ch·∫£ c√° t∆∞∆°i (kg)', price: 120000, salePrice: null, category: 'chaca', image: 'üêü' },
    { id: 3, name: 'B√°nh m√¨ nem n∆∞·ªõng', price: 25000, salePrice: null, category: 'banhmi', image: 'üç¢' },
    { id: 4, name: 'X√¥i ch·∫£ c√° ƒë·∫∑c bi·ªát', price: 30000, salePrice: 25000, category: 'combo', image: 'üçö' },
    { id: 5, name: 'Combo gia ƒë√¨nh 4 ng∆∞·ªùi', price: 150000, salePrice: null, category: 'combo', image: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
    { id: 6, name: 'Ch·∫£ c√° Nha Trang (kg)', price: 150000, salePrice: 135000, category: 'chaca', image: 'üê†' }
];
const branches = [
    { id: 'q1', name: 'Chi nh√°nh Qu·∫≠n 1', emoji: 'üè¢', address: '123 ƒê∆∞·ªùng A, Qu·∫≠n 1, TPHCM', phone: '028.123.4567' },
    { id: 'gv', name: 'Chi nh√°nh G√≤ V·∫•p', emoji: 'üè™', address: '456 ƒê∆∞·ªùng B, Qu·∫≠n G√≤ V·∫•p, TPHCM', phone: '028.234.5678' },
    { id: 'bt', name: 'Chi nh√°nh B√¨nh Th·∫°nh', emoji: 'üèòÔ∏è', address: '789 ƒê∆∞·ªùng C, Qu·∫≠n B√¨nh Th·∫°nh, TPHCM', phone: '028.456.7890' },
];
</script>
</html>
